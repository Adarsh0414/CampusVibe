<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#3b82f6">
  <title>Profile - CampusVibe</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/lottie.min.js"></script>
  <style>
    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid #3b82f6; }
    .profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin: 24px 0; }
    .stat-card { text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @media (max-width: 768px) { .row { flex-direction: column; gap: 16px; } }
  </style>
</head>
<body>
  <header class="cv-header">
    <div class="container header-inner">
      <a href="/" class="brand" style="text-decoration:none;color:inherit">
        <img src="/assets/img/logo.svg" class="logo" alt="CampusVibe" />
        <div class="brand-text">
          <h1>CampusVibe</h1>
          <p class="tagline">Ideal Management, Ideal Moments</p>
        </div>
      </a>
      <a class="btn outline" href="/">Home</a>
    </div>
  </header>

  <main class="container" style="max-width:720px;padding:24px 0;">
  <!-- Loading skeleton -->
  <div id="loading" style="text-align:center;padding:60px 20px;">
    <div class="skeleton" style="width:80px;height:80px;margin:0 auto 20px;border-radius:50%;"></div>
    <div class="skeleton" style="width:300px;height:20px;margin:0 auto 16px;"></div>
    <div class="skeleton" style="width:200px;height:20px;margin:0 auto;"></div>
  </div>
  
  <div id="profile-content" style="display:none;">
    <div class="flex" style="gap:20px;align-items:center;margin-bottom:24px;">
      <img id="avatar" class="profile-avatar" src="/assets/img/avatar-default.svg" alt="Profile" />
      <div>
        <h2 id="displayName">Loading...</h2>
        <p id="displayEmail" class="muted">Loading...</p>
      </div>
    </div>
    
    <div class="profile-stats" id="stats"></div>
    
    <div id="msg"></div>
    <form id="profileForm" novalidate style="background:rgba(255,255,255,0.03);padding:24px;border-radius:12px;">
      <div class="row">
        <div class="flex-col">
          <label class="label">Full Name</label>
          <input id="name" class="input" required maxlength="50" />
        </div>
        <div class="flex-col">
          <label class="label">Email (verified)</label>
          <input id="email" class="input" disabled />
        </div>
      </div>
      <div class="row">
        <div class="flex-col">
          <label class="label">Mobile</label>
          <input id="mobile" class="input" maxlength="15" placeholder="+91 9876543210" />
        </div>
        <div class="flex-col">
          <label class="label">Roll Number</label>
          <input id="roll" class="input" maxlength="20" placeholder="20BCSE123" />
        </div>
      </div>
      <div class="flex" style="gap:12px;justify-content:flex-end;margin-top:24px;">
        <button type="button" class="btn outline" id="cancel">Cancel</button>
        <button type="submit" class="btn primary" id="save">
          <span class="spinner" style="display:none;"></span>
          Save Changes
        </button>
      </div>
    </form>
  </div>
</main>

  <script>
document.addEventListener('DOMContentLoaded', async () => {
  await loadProfile();
  initLottie();
});

async function loadProfile() {
  try {
    const res = await fetch('/api/auth/me', { credentials: 'include' });
    if (!res.ok) {
      if (res.status === 401) location.href = '/login.html';
      return;
    }
    
    const { user } = await res.json();
    renderProfile(user);
    initForm(user);
  } catch (error) {
    document.getElementById('msg').innerHTML = '<div class="alert warn">Failed to load profile</div>';
  }
}

function renderProfile(user) {
  document.getElementById('avatar').src = user.avatar_url || '/assets/img/avatar-default.svg';
  document.getElementById('displayName').textContent = user.name || 'User';
  document.getElementById('displayEmail').textContent = user.email;
  
  // Stats cards
  const stats = document.getElementById('stats');
  stats.innerHTML = `
    <div class="stat-card">
      <div style="font-size:28px;font-weight:bold;color:#10b981;">${user.ticket_count || 0}</div>
      <div style="font-size:12px;color:#9ca3af;">Tickets</div>
    </div>
    <div class="stat-card">
      <div style="font-size:28px;font-weight:bold;color:#3b82f6;">${user.events_organized || 0}</div>
      <div style="font-size:12px;color:#9ca3af;">Events</div>
    </div>
  `;
  
  document.getElementById('loading').style.display = 'none';
  document.getElementById('profile-content').style.display = 'block';
}

function initForm(user) {
  document.getElementById('name').value = user.name || '';
  document.getElementById('email').value = user.email;
  document.getElementById('mobile').value = user.mobile || '';
  document.getElementById('roll').value = user.roll_number || '';
  
  const form = document.getElementById('profileForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      const body = {
        name: document.getElementById('name').value.trim(),
        mobile: document.getElementById('mobile').value.trim(),
        roll_number: document.getElementById('roll').value.trim()
      };
      
      const res = await fetch('/api/users/me', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });
      
      if (res.ok) {
        showMessage('✅ Profile updated successfully!', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showMessage('❌ Failed to update profile', 'error');
      }
    } catch (error) {
      showMessage('Network error. Please try again.', 'error');
    } finally {
      setLoading(false);
    }
  });
  
  // Cancel button
  document.getElementById('cancel').addEventListener('click', () => {
    loadProfile(); // Reload original data
  });
  
  // Logout
  document.querySelector('#save ~ button')?.addEventListener('click', async () => {
    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
    location.href = '/';
  });
}

function setLoading(loading) {
  const btn = document.getElementById('save');
  const spinner = btn.querySelector('.spinner');
  btn.disabled = loading;
  
  if (loading) {
    spinner.style.display = 'inline-block';
    btn.innerHTML = '<span class="spinner"></span>Saving...';
  } else {
    spinner.style.display = 'none';
    btn.textContent = 'Save Changes';
  }
}

function showMessage(text, type) {
  const msg = document.getElementById('msg');
  msg.innerHTML = `<div class="alert ${type}">${text}</div>`;
  setTimeout(() => msg.innerHTML = '', 4000);
}

function initLottie() {
  try {
    if (window.lottie) {
      window.lottie.loadAnimation({
        container: document.getElementById('lottie-profile'),
        renderer: 'svg', loop: true, autoplay: true,
        path: '/assets/lottie/profile.json'
      });
    }
  } catch (e) { console.warn('Lottie failed'); }
}
</script>
</body>
</html>
