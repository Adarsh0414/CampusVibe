<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizer Dashboard - CampusVibe</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    .card h3, .card .label {
      font-weight: bold;
      color: black;
    }

    .status-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: white;
      font-weight: 500;
    }
    /* ========== NEW: LOADING SPINNER ========== */
    .spinner {
      display: inline-block; width: 16px; height: 16px; 
      border: 2px solid white; border-top: 2px solid white; 
      border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== NEW: ACCESSIBILITY FOCUS STYLES ========== */
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid #007bff; outline-offset: 2px;
    }

    /* ========== NEW: VALIDATION FEEDBACK ========== */
    .input.invalid { border-color: #ef4444 !important; box-shadow: 0 0 0 2px #ef444440; }
    .input.valid { border-color: #10b981 !important; box-shadow: 0 0 0 2px #10b98140; }

    /* ========== NEW: RESPONSIVE FIX ========== */
    @media (max-width: 768px) { .row { flex-direction: column !important; gap: 12px; } }

    #toast {
  position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; 
  color: white; z-index: 10000; transform: translateX(400px); transition: all 0.3s; 
  font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #toast.show { transform: translateX(0); }
    #toast.success { background: #10b981; }
    #toast.error { background: #ef4444; }
  </style>
  <script src="/assets/js/lottie.min.js"></script>
</head>
<body>
  <header class="cv-header">
    <div class="container header-inner">
      <a href="/" class="brand" style="text-decoration:none;color:inherit">
        <img src="/assets/img/logo.svg" class="logo" alt="CampusVibe" />
        <div class="brand-text">
          <h1>CampusVibe</h1>
          <p class="tagline">Ideal Management, Ideal Moments</p>
        </div>
      </a>
      <nav class="nav">
        <a href="/" class="nav-link">Home</a>
        <a href="/attendance.html">Attendance</a>
        <a href="/profile.html">Profile</a>
        <a href="#" id="logoutBtn" class="btn outline">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:24px 0;">
    <div id="lottie-dash" style="height:140px; opacity:.5; margin-bottom:8px;"></div>
    <div class="row" id="quick-stats" style="margin-bottom:16px;"></div>
    <div class="row">
      <div class="card">
        <h3>Create Event</h3>
        <div class="form">
          <input class="input" id="title" placeholder="Title" />
          <textarea class="input" id="desc" placeholder="Description"></textarea>
          <div class="row">
            <input class="input" id="category" placeholder="Category" />
            <input class="input" id="location" placeholder="Location" />
          </div>
          <div class="row">
            <div class="flex-col"><label class="label">Start time</label><input class="input" id="start" type="datetime-local" /></div>
            <div class="flex-col"><label class="label">Finish time</label><input class="input" id="end" type="datetime-local" /></div>
          </div>
          <div class="row">
            <input class="input" id="capacity" type="number" placeholder="Capacity (optional)" />
            <input class="input" id="price" type="number" placeholder="Legacy base price (cents, optional)" />
          </div>
          <div class="card" style="margin:8px 0; background: rgba(255,255,255,0.03);">
            <h4 style="margin:6px 0;">Ticket Tiers & Pricing</h4>
            <div class="row">
              <div class="flex-col">
                <label class="label">Allowed Tiers</label>
                <div class="flex" style="flex-wrap:wrap; gap:10px;">
                  <label><input type="checkbox" id="allow_single" checked /> Single</label>
                  <label><input type="checkbox" id="allow_duo" /> Duo</label>
                  <label><input type="checkbox" id="allow_trio" /> Trio</label>
                </div>
                <p class="muted">Share specific registration links to enforce the tier (e.g., .../event.html?e=UUID&type=duo)</p>
              </div>
              <div class="flex-col">
                <label class="label">Prices (₹)</label>
                <div class="row">
                  <input class="input" id="price_single" type="number" placeholder="Single price in ₹ (e.g., 90)" />
                  <input class="input" id="price_duo" type="number" placeholder="Duo price in ₹ (e.g., 180)" />
                </div>
                <div class="row">
                  <input class="input" id="price_trio" type="number" placeholder="Trio price in ₹ (e.g., 250)" />
                  <div></div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <select class="input" id="status">
              <option value="published">Published</option>
              <option value="draft">Draft</option>
            </select>
            <select class="input" id="visibility">
              <option value="public">Public</option>
              <option value="private">Private</option>
            </select>
          </div>
          <button class="btn primary" id="create">Create</button>
        </div>
      </div>
      <div class="card">
        <h3>Your Events</h3>
        <div id="events"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card">
        <h3>Payment Setup (Bank/UPI)</h3>
        <div class="form">
          <input class="input" id="e_uuid" placeholder="Event UUID" />
          <input class="input" id="acc_name" placeholder="Account Name" />
          <input class="input" id="acc_no" placeholder="Account Number" />
          <input class="input" id="ifsc" placeholder="IFSC Code" />
          <input class="input" id="upi" placeholder="UPI ID (e.g., name@bank)" />
          <input class="input" id="upi_qr" type="file" accept="image/*" />
          <textarea class="input" id="notes" placeholder="Payment notes/instructions"></textarea>
          <button class="btn primary" id="savePay">Save Payment Setup</button>
        </div>
      </div>
      <div class="card">
        <h3>Payment Proofs</h3>
        <div class="form">
          <input class="input" id="e_uuid_list" placeholder="Event UUID" />
          <button class="btn outline" id="listProofs">List Proofs</button>
        </div>
        <div id="proofs"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Analytics</h3>
      <div id="analytics"></div>
    </div>
    <div id="toast"></div>
  </main>

  <script>
    /* ========== NEW: DOM CACHING (ADD AT TOP - REPLACES REPEATED getElementById) ========== */
    const els = {
      title: document.getElementById('title'),
      start: document.getElementById('start'),
      end: document.getElementById('end'),
      create: document.getElementById('create'),
      events: document.getElementById('events'),
      analytics: document.getElementById('analytics'),
      e_uuid: document.getElementById('e_uuid'),
      e_uuid_list: document.getElementById('e_uuid_list'),
      savePay: document.getElementById('savePay'),
      listProofs: document.getElementById('listProofs'),
      proofs: document.getElementById('proofs'),
      logoutBtn: document.getElementById('logoutBtn'),
      lottieDash: document.getElementById('lottie-dash')
    };

    /* ========== NEW: UTILITY FUNCTIONS (ADD BEFORE EXISTING FUNCTIONS) ========== */
    // Toast notifications - REPLACES ALL alert()
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    // Improved loading with spinner
    function withLoading(btn, fn) {
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Loading...';
      return fn().finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      });
    }

    // Form validation helper
    function validateEventForm() {
      const title = els.title.value.trim();
      const start = els.start.value;
      const end = els.end.value;
      
      if (!title) {
        els.title.classList.add('invalid');
        showToast('Title is required', 'error');
        els.title.focus();
        return false;
      }
      if (!start) {
        els.start.classList.add('invalid');
        showToast('Start time is required', 'error');
        return false;
      }
      if (end && new Date(end) <= new Date(start)) {
        showToast('End time must be after start time', 'error');
        return false;
      }
      return true;
    }
    
    // Require organizer/admin
    (async () => {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (!res.ok) { location.href = '/login.html'; return; }
      const { user } = await res.json();
      if (!(user.role === 'committee' || user.role === 'admin')) {
        showToast('Organizer access required', 'error'); // CHANGED: alert -> showToast
        location.href = '/login.html';
      }
    })();

    document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
        showToast('Logged out successfully'); // CHANGED: Added success feedback
      } catch (_) {}
      location.href = '/';
    });

    async function createEvent() {
      // NEW: Validation
      if (!validateEventForm()) return;
      
      // NEW: Clear previous validation
      [els.title, els.start].forEach(el => el.classList.remove('invalid'));

  const allow_single = document.getElementById('allow_single');
  const allow_duo = document.getElementById('allow_duo');
  const allow_trio = document.getElementById('allow_trio');
  const price_single = document.getElementById('price_single');
  const price_duo = document.getElementById('price_duo');
  const price_trio = document.getElementById('price_trio');
  const desc = document.getElementById('desc');
  const category = document.getElementById('category');
  const location = document.getElementById('location');
  const end = document.getElementById('end');
  const capacity = document.getElementById('capacity');
  const price = document.getElementById('price');
  const status = document.getElementById('status');
  const visibility = document.getElementById('visibility');

  const btn = document.getElementById('create');
  await withLoading(els.create, async () => {
    const allowed = [];
    if (allow_single.checked) allowed.push('single');
    if (allow_duo.checked) allowed.push('duo');
    if (allow_trio.checked) allowed.push('trio');
    const price_single_cents = price_single.value ? Math.round(Number(price_single.value) * 100) : null;
    const price_duo_cents = price_duo.value ? Math.round(Number(price_duo.value) * 100) : null;
    const price_trio_cents = price_trio.value ? Math.round(Number(price_trio.value) * 100) : null;

    const body = {
      title: els.title.value,
      description: desc.value,
      category: category.value,
      location: location.value,
      start_time: els.start.value,
      end_time: end.value,
      capacity: Number(capacity.value) || null,
      price_cents: Number(price.value) || 0,
      status: status.value,
      visibility: visibility.value,
      price_single_cents,
      price_duo_cents,
      price_trio_cents,
      allowed_tiers: allowed.join(',') || 'single'
    };
    const res = await fetch('/api/events', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      credentials: 'include', 
      body: JSON.stringify(body) 
    });
    if (res.ok) { 
      loadEvents(); 
      showToast('Event created successfully!'); // CHANGED: alert -> showToast 
      document.querySelectorAll('.form .input, .form textarea, .form select').forEach(input => input.value = '');
      document.querySelectorAll('.form input[type="checkbox"]').forEach(cb => cb.checked = cb.id === 'allow_single');
    } else {
      const text = await res.text().catch(() => 'Unknown error');
      showToast('Failed: ' + text, 'error'); // CHANGED: alert -> showToast
    }
  });
}

document.getElementById('create').addEventListener('click', createEvent);


    function withLoading(btn, fn) {
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Loading...';
      return fn().finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      });
    }

    async function loadEvents() {
      const res = await fetch('/api/organizer/my-events?active_only=1', { credentials: 'include' });
      if (!res.ok) { 
        els.events.innerHTML = '<div class="muted">Failed to load events</div>'; 
        showToast('Failed to load events', 'error'); // NEW: Feedback
        return; 
      }
      const data = await res.json();

      document.getElementById('quick-stats').innerHTML = `
        <div class="card" style="flex:1;">
          <h4>Total Events</h4>
          <div style="font-size:24px; font-weight:bold;">${data.events.length}</div>
        </div>
      `;

      els.events.innerHTML = '';
      data.events.forEach(e => {
        const div = document.createElement('div');
        div.className = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.borderBottom = '1px solid #263062';
        div.style.padding = '8px 0';
        div.innerHTML = `<div><b>${e.title}</b> <span class="muted">(${new Date(e.start_time).toLocaleString()})</span><br/><small>${e.uuid}</small></div>`;
        
        const btns = document.createElement('div');
        const btnA = document.createElement('button');
        btnA.className = 'btn outline';
        btnA.textContent = 'View Analytics';
        btnA.dataset.action = 'analytics';
        btnA.dataset.uuid = e.uuid;
        btnA.setAttribute('aria-label', `View analytics for ${e.title}`);
        
        const btnP = document.createElement('button');
        btnP.className = 'btn outline';
        btnP.textContent = 'Payment Setup';
        btnP.dataset.action = 'payment';
        btnP.dataset.uuid = e.uuid;
        
        const btnE = document.createElement('button');
        btnE.className = 'btn outline';
        btnE.textContent = 'Edit';
        btnE.dataset.action = 'edit';
        btnE.dataset.uuid = e.uuid;
        
        const btnD = document.createElement('button');
        btnD.className = 'btn danger';
        btnD.textContent = 'Delete';
        btnD.dataset.action = 'delete';
        btnD.dataset.uuid = e.uuid;
        
        btns.appendChild(btnA); btns.appendChild(btnP); btns.appendChild(btnE); btns.appendChild(btnD);
        div.appendChild(btns);
        els.events.appendChild(div);
      });

      /* ========== NEW: SINGLE EVENT DELEGATION (REPLACES 100s OF LISTENERS) ========== */
      els.events.removeEventListener('click', handleEventClick); // Prevent duplicates
      els.events.addEventListener('click', handleEventClick);
    }

    /* ========== NEW: EVENT DELEGATION HANDLER ========== */
    async function handleEventClick(e) {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      
      const uuid = btn.dataset.uuid;
      const action = btn.dataset.action;
      
      switch(action) {
        case 'analytics':
          await withLoading(btn, async () => {
            const r = await fetch(`/api/analytics/events/${uuid}`, { credentials: 'include' });
            if (!r.ok) return showToast('Forbidden or not found', 'error');
            const a = await r.json();
            els.analytics.innerHTML = `
              <div>Total Registrations: ${a.metrics.totalRegistrations}</div>
              <div>Paid: ${a.metrics.paid}</div>
              <div>Checked-in: ${a.metrics.checkedIn}</div>
            `;
            showToast('Analytics loaded');
          });
          break;
          
        case 'payment':
          els.e_uuid.value = uuid;
          els.e_uuid_list.value = uuid;
          showToast('Payment fields filled');
          break;
          
        case 'edit':
          // TEMP: Keep your prompt for now, replace with modal later
          const titleNew = prompt('Title', e.target.closest('.flex').querySelector('b').textContent) ?? '';
          if (!titleNew) return;
          showToast('Edit with modal coming soon!');
          break;
          
        case 'delete':
          if (!confirm('Delete this event? This action cannot be undone.')) return;
          await withLoading(btn, async () => {
            const r = await fetch(`/api/events/${uuid}`, { method: 'DELETE', credentials: 'include' });
            if (r.ok) {
              showToast('Event deleted');
              loadEvents();
            } else {
              showToast('Failed to delete', 'error');
            }
          });
          break;
      }
    }

    loadEvents();

    document.getElementById('savePay').addEventListener('click', async () => {
      const e_uuid = els.e_uuid.value.trim();
      if (!e_uuid) {
        showToast('Event UUID is required', 'error');
        return;
      }

      const btn = document.getElementById('savePay');
      await withLoading(els.savePay, async () => {
      const acc_name = document.getElementById('acc_name').value;
      const acc_no = document.getElementById('acc_no').value;
      const ifsc = document.getElementById('ifsc').value;
      const upi = document.getElementById('upi').value;
      const notes = document.getElementById('notes').value;
      const upi_qr = document.getElementById('upi_qr');

      const fd = new FormData();
      fd.append('bank_account_name', acc_name);
      fd.append('bank_account_no', acc_no);
      fd.append('bank_ifsc', ifsc);
      fd.append('upi_id', upi);
      fd.append('payment_notes', notes);
      if (upi_qr.files[0]) fd.append('upi_qr', upi_qr.files[0]);
      const res = await fetch(`/api/events/${e_uuid}/payment-setup`, { method: 'PUT', credentials: 'include', body: fd });
      showToast(res.ok ? 'Payment setup saved!' : 'Failed to save', res.ok ? 'success' : 'error'); // CHANGED
    });
  });

    document.getElementById('listProofs').addEventListener('click', async () => {
      const e_uuid_list_input = document.getElementById('e_uuid_list');
      const e_uuid_list = els.e_uuid_list.value.trim();
      if (!e_uuid_list) {
        showToast('Event UUID required', 'error');
        return;
      }
      const btn = document.getElementById('listProofs');

      await withLoading(els.listProofs, async () => {
        const res = await fetch(`/api/organizer/events/${e_uuid_list.value}/payments?status=pending`, { credentials: 'include' });
        if (!res.ok) return showToast('Failed to load proofs', 'error');
        
        const data = await res.json();
        const root = document.getElementById('proofs');
        els.proofs.innerHTML = '';
        data.payments.forEach(p => {
          const d = document.createElement('div');
          d.className = 'card';
          d.innerHTML = `
          <div>Ticket: ${p.ticket_uuid}</div>
          <div>User: ${p.user_name} (${p.user_email})</div>
          <div>Txn ID: ${p.proof_txn_id || '-'}</div>
          ${p.proof_image_url ? `<img src="${p.proof_image_url}" style="max-width:260px;border-radius:8px;" />` : ''}
          <div class="flex" style="margin-top:8px;">
            <button class="btn primary" data-approve="${p.ticket_uuid}">Approve</button>
            <button class="btn danger" data-reject="${p.ticket_uuid}">Reject</button>
          </div>
        `;
        d.querySelector('[data-approve]').onclick = () => approvePayment(p.ticket_uuid);
        d.querySelector('[data-reject]').onclick = () => rejectPayment(p.ticket_uuid);
        els.proofs.appendChild(d);
      });
      showToast(`${data.payments.length} proofs loaded`);
    });
  });

  async function approvePayment(ticketUuid) {
      const res = await fetch(`/api/organizer/payments/${ticketUuid}/approve`, { method: 'POST', credentials: 'include' });
      showToast(res.ok ? 'Approved!' : 'Failed', res.ok ? 'success' : 'error');
      document.getElementById('listProofs').click(); // Reload
    }

    async function rejectPayment(ticketUuid) {
      const reason = prompt('Reason for rejection?');
      if (!reason) return;
      const res = await fetch(`/api/organizer/payments/${ticketUuid}/reject`, { 
        method: 'POST', credentials: 'include', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ reason }) 
      });
      showToast(res.ok ? 'Rejected' : 'Failed', res.ok ? 'success' : 'error');
      document.getElementById('listProofs').click();
    }

    try {
      if (window.lottie) {
        window.lottie.loadAnimation({
          container: document.getElementById('lottie-dash'),
          renderer: 'svg', loop: true, autoplay: true,
          path: '/assets/lottie/dashboard.json'
        });
      }
    } catch (e) { /* ignore */ }
  </script>
</body>
</html>
