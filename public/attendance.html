<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance - CampusVibe</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/lottie.min.js"></script>
</head>
<body>
  <header class="cv-header">
    <div class="container header-inner">
      <a href="/" class="brand" style="text-decoration:none;color:inherit">
        <img src="/assets/img/logo.svg" class="logo" alt="CampusVibe" />
        <div class="brand-text">
          <h1>CampusVibe</h1>
          <p class="tagline">Ideal Management, Ideal Moments</p>
        </div>
      </a>
      <a class="btn outline" href="/">Home</a>
      <a class="btn outline" href="/dashboard.html">Dashboard</a>
    </div>
  </header>

  <main class="container" style="padding:24px 0;">
    <div class="card">
      <h3>QR Scan</h3>
      <p class="muted">Use the camera to scan ticket QR codes, or paste the QR payload JSON manually. Only paid tickets can be marked present.</p>
      <div id="lottie-scan" style="height:120px; opacity:.5; margin-bottom:8px;"></div>
      <div class="row">
        <div class="flex-col" style="min-width:260px;">
          <video id="preview" playsinline style="width:100%; background:#000; border-radius:8px;"></video>
          <div class="flex" style="margin-top:8px;">
            <button class="btn outline" id="startCam">Start Camera</button>
            <button class="btn outline" id="stopCam">Stop</button>
            <select class="input" id="cameraSelect"></select>
          </div>
        </div>
        <div class="flex-col">
          <h4>Manual Paste</h4>
          <textarea id="code" class="input" placeholder='Paste QR JSON here. Example: {"ticket_uuid":"...","event_uuid":"...","user_id":123,"sig":"..."}'></textarea>
          <button class="btn primary" id="scan">Mark Present</button>
          <div id="msg"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Manual Attendance</h3>
      <p class="muted">For edge cases only. Prefer scanning QR to ensure authenticity.</p>
      <div class="row">
        <input class="input" id="eventId" type="number" placeholder="Event ID" />
        <input class="input" id="userId" type="number" placeholder="User ID" />
      </div>
      <div class="flex">
        <label><input type="checkbox" id="present" checked /> Present</label>
      </div>
      <button class="btn primary" id="mark">Save</button>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Offline Backup</h3>
      <p class="muted">Export current attendance as JSON or import previously exported JSON.</p>
      <div class="flex">
        <input class="input" id="exportEvent" placeholder="Event ID for export" />
        <button class="btn outline" id="exportBtn">Export</button>
      </div>
      <div class="flex" style="margin-top:8px;">
        <textarea class="input" id="importText" placeholder="Paste exported JSON here"></textarea>
      </div>
      <button class="btn outline" id="importBtn">Import</button>
    </div>
  </main>

  <script>
    // Require organizer/admin
    (async () => {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (!res.ok) { location.href = '/login.html'; return; }
      const { user } = await res.json();
      if (!(user.role === 'committee' || user.role === 'admin')) {
        alert('Organizer access required');
        location.href = '/login.html';
        return; // stop further JS execution
      }
    })();

    async function postCode(code) {
      const res = await fetch('/api/attendance/scan', { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify({ code }) });
      const msg = document.getElementById('msg');
      if (res.ok) {
        const data = await res.json();
        if (data.already) { msg.innerHTML = `<div class="alert info">Already checked-in: ${data.details.user_name} (${data.details.user_email})</div>`;
        } else { 
          msg.innerHTML = `<div class="alert info">Checked-in: ${data.details.user_name} (${data.details.user_email})</div>`;
        }
      } else {
        const text = await res.text().catch(() => '');
        msg.innerHTML = `<div class="alert warn">Failed${text ? ': ' + text : ''}</div>`;
      }
    }

    document.getElementById('scan').addEventListener('click', async () => {
      const code = document.getElementById('code').value;
      postCode(code);
    });

    // Camera QR scanning using BarcodeDetector if available, fallback to jsQR (optional external library not included)
    const video = document.getElementById('preview');
    const cameraSelect = document.getElementById('cameraSelect');
    let stream; let scanning = false; let rafId;

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = '';
      cams.forEach((c, idx) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${idx + 1}`;
        cameraSelect.appendChild(opt);
      });
    }

    async function startCamera() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Camera API not supported in this browser.');
          return;
        }
        await listCameras();
        const deviceId = cameraSelect.value || undefined;
        stream = await navigator.mediaDevices.getUserMedia({ video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' } });
        video.srcObject = stream; await video.play(); scanning = true; scanLoop();
      } catch (e) {
        alert('Camera error: ' + e.message);
      }
    }

    function stopCamera() {
      scanning = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
    }

    async function scanLoop() {
      if (!('BarcodeDetector' in window)) { return; }
      const detector = new BarcodeDetector({ formats: ['qr_code'] });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const tick = async () => {
        if (!scanning) return;
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        if (canvas.width && canvas.height) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          try {
            const codes = await detector.detect(canvas);
            if (codes.length) {
              const raw = codes[0].rawValue;
              stopCamera();
              postCode(raw);
              return;
            }
          } catch (_) {}
        }
        rafId = requestAnimationFrame(tick);
      };
      tick();
    }

    document.getElementById('startCam').addEventListener('click', startCamera);
    document.getElementById('stopCam').addEventListener('click', stopCamera);
    if (!('BarcodeDetector' in window)) {
      const info = document.getElementById('msg');
      info.innerHTML = '<div class="alert warn">BarcodeDetector not supported on this browser. Use manual paste or a supported browser.</div>';
    }

    document.getElementById('mark').addEventListener('click', async () => {
      const eventIdVal = Number(eventId.value);
      const userIdVal = Number(userId.value);
      if (!eventIdVal || !userIdVal) {
        alert('Please enter valid Event ID and User ID.');
        return;
      }
      const body = { event_id: eventIdVal, user_id: userIdVal, present: present.checked };
      const res = await fetch('/api/attendance/manual', { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify(body) });
      const text = await res.text().catch(() => '');
      alert(res.ok ? 'Saved' : ('Failed' + (text ? ': ' + text : '')));
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
      const id = Number(exportEvent.value);
      if (!id) {
        alert('Please enter a valid Event ID.');
        return;
      }
      const res = await fetch(`/api/attendance/${id}/export`, { credentials: 'include' });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        alert('Failed' + (text ? ': ' + text : ''));
        return;
      } 
      const data = await res.json();
      const txt = JSON.stringify(data, null, 2);
      try {
        if (!navigator.clipboard || !navigator.clipboard.writeText) {
          throw new Error('Clipboard API not available');
        }
        await navigator.clipboard.writeText(txt);
        alert('Copied JSON to clipboard');
      } catch (e) {
        alert('Could not copy to clipboard. Please copy manually:\n\n' + txt);
      }
    });

    document.getElementById('importBtn').addEventListener('click', async () => {
      const id = Number(exportEvent.value);
      if (!id) {
        alert('Please enter a valid Event ID.');
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(importText.value || '{}');
      } catch (e) {
        alert('Invalid JSON. Please check your pasted data.');
        return;
      }

      const attendance = parsed.attendance || [];
      const res = await fetch(`/api/attendance/${id}/import`, { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify({ attendance }) });
      const text = await res.text().catch(() => '');
      alert(res.ok ? 'Imported' : ('Failed' + (text ? ': ' + text : '')));
    });

    try {
      if (window.lottie) {
        window.lottie.loadAnimation({
          container: document.getElementById('lottie-scan'),
          renderer: 'svg', loop: true, autoplay: true,
          path: '/assets/lottie/scan.json'
        });
      }
    } catch (e) { /* ignore */ }
  </script>
</body>
</html>
