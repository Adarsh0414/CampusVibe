<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CampusVibe - Ideal Management, Ideal Moments</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <meta name="description" content="CampusVibe - campus event management platform.Register, pay, get e-tickets with QR codes. Real-time attendance tracking for organizers." />
  <meta name="keywords" content="campus events, college fest, event registration, e-tickets, QR attendance" />
  <meta property="og:title" content="CampusVibe - Ideal Management, Ideal Moments" />
  <meta property="og:description" content="Find campus events, register instantly, get QR e-tickets" />
  <meta property="og:image" content="/assets/img/og-image.jpg" />
  <link rel="canonical" href="/" />
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <script src="/assets/js/lottie.min.js"></script>
  <style>
    .hero-lottie { position: relative; width: 100%; height: 220px; margin-top: 16px; }
    .hero-lottie .layer { position: absolute; inset: 0; pointer-events: none; opacity: .9; }
    @media (max-width: 700px) { .hero-lottie { height: 180px; } }
    .event-card { 
      display: block; transition: transform 0.2s; border-radius: 12px; overflow: hidden; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-decoration: none; color: inherit;
    }
    .event-card:hover { transform: translateY(-4px); }
    .event-body { padding: 16px; }
    .badge, .status-badge, .price, .free { 
      padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; 
    }
    .badge { background: rgba(255,255,255,0.2); color: white; }
    .status-badge.success { background: #10b981; color: white; }
    .free { background: #10b981; color: white; }
    .price { background: #ef4444; color: white; }
    .truncate { 
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; box-orient: vertical; 
      overflow: hidden; margin: 8px 0; 
    }
    .loading, .skeleton { 
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
      background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px;
    }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .empty-state { text-align: center; padding: 4rem 2rem; color: whitesmoke;}
    .filters { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; padding: 16px; margin-bottom: 24px; }
    .filter-group { position: relative; flex: 1; min-width: 200px; }
  </style>
</head>
<body>
  <header class="cv-header glass">
    <div class="container header-inner">
      <a href="/" class="brand" style="text-decoration:none;color:inherit">
        <img src="/assets/img/logo.svg" alt="CampusVibe" class="logo spin-in" />
        <div class="brand-text">
          <h1>CampusVibe</h1>
          <p class="tagline">Ideal Management, Ideal Moments</p>
        </div>
      </a>
      <nav class="nav" id="nav">
        <a href="/login.html" class="nav-link">Login</a>
        <a href="/register.html" class="nav-link">Register</a>
        <a href="/faq.html" class="nav-link">Help</a>
      </nav>
    </div>
  </header>

  <section class="hero gradient-bg">
    <div class="container hero-inner">
      <h2 class="reveal">Find your next campus moment</h2>
      <p class="reveal delay-1">Register, pay, and get your e‚Äëticket with a secure QR. Real‚Äëtime attendance and analytics for organizers.</p>
      <div class="hero-actions reveal delay-2">
        <a class="btn primary pulse" href="#catalog">Browse Events</a>
        <a class="btn outline" href="/my-tickets.html">My Tickets</a>
      </div>
      <div class="feature-bar reveal delay-3" id="features">
        <a class="feature" href="#catalog"><span>üéâ</span> Events</a>
        <a class="feature" href="/my-tickets.html"><span>üéüÔ∏è</span> My Tickets</a>
        <a class="feature" href="/profile.html"><span>üë§</span> Profile</a>
        <a class="feature" href="/dashboard.html"><span>üõ†Ô∏è</span> Organizer</a>
        <a class="feature" href="/attendance.html"><span>‚úÖ</span> Attendance</a>
        <a class="feature" href="/faq.html"><span>‚ùì</span> Help</a>
      </div>
      <div class="hero-lottie">
        <div id="lottie-hero" class="layer"></div>
      </div>
    </div>
  </section>

  <main class="container" id="catalog">
    <div class="filters glass">
      <div class="filter-group">
        <input type="search" id="search" placeholder="üîç Search events (e.g., fest, workshop)..." />
        <div class="loading" id="search-loading" style="display:none;">Searching...</div>
      </div>
    <select id="category">
      <option value="">All Events</option>
      <option value="technical">Technical</option>
      <option value="cultural">Cultural</option>
      <option value="sports">Sports</option>
      <option value="workshop">Workshops</option>
    </select>
    <select id="sort">
      <option value="start_time">Soonest</option>
      <option value="-start_time">Latest</option>
      <option value="title">A-Z</option>
      <option value="price">Price Low-High</option>
    </select>
  </div>

    <div id="events" class="grid">
      <!-- Skeleton loaders (shows while loading) -->
      <div class="event-card skeleton" style="height: 200px;"></div>
      <div class="event-card skeleton" style="height: 200px;"></div>
      <div class="event-card skeleton" style="height: 200px;"></div>
    </div>
  </main>

  <footer class="cv-footer">
    <div class="container">
      <p>&copy; <span id="year"></span> CampusVibe. Ideal Management, Ideal Moments.</p>
      <a href="/faq.html">FAQ / Help</a>
    </div>
  </footer>

  <script src="/assets/js/app.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Lottie animation
    try {
      if (window.lottie && document.getElementById('lottie-hero')) {
        window.lottie.loadAnimation({
          container: document.getElementById('lottie-hero'),
          renderer: 'svg', loop: true, autoplay: true,
          path: '/assets/lottie/hero.json'
        });
      }
    } catch (e) { console.warn('Hero animation failed'); }
    
    await loadEvents();
    setupFilters();
  });

  async function loadEvents() {
    const eventsEl = document.getElementById('events');
    try {
      eventsEl.innerHTML = ''; 
      const res = await fetch('/api/events?public=1&limit=12', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to load events');
      const { events } = await res.json();

      // üö® NEW: Filter expired events (end_time passed OR start_time + 24h passed)
    const now = new Date().toISOString();
    const liveEvents = events.filter(event => {
      const endTime = event.end_time || new Date(new Date(event.start_time).getTime() + 24*60*60*1000).toISOString();
      return endTime > now;
    });
      
      renderEvents(eventsEl, liveEvents);
    } catch (error) {
      eventsEl.innerHTML = `
        <div class="empty-state">
          <h3>No events available</h3>
          <p>Check back soon for exciting campus events!</p>
          <a href="/faq.html" class="btn outline">Need Help?</a>
        </div>
      `;
    }
  }

  function setupFilters() {
    const search = document.getElementById('search');
    const category = document.getElementById('category');
    const sort = document.getElementById('sort');

    let timeout;
    search.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => filterEvents(), 300);
    });

    [category, sort].forEach(el => el.addEventListener('change', filterEvents));
  }

  async function filterEvents() {
    const search = document.getElementById('search').value.toLowerCase();
    const category = document.getElementById('category').value;
    const sort = document.getElementById('sort').value;

    const eventsEl = document.getElementById('events');
    eventsEl.innerHTML = '<div class="loading" style="height:200px;padding:40px;">Filtering events...</div>';

    const params = new URLSearchParams({ search, category, sort, public: 1, limit: 20 });
    try {
      const res = await fetch(`/api/events?${params}`, { credentials: 'include' });
      if (!res.ok) {
        loadEvents();
        return;
      }
      const { events } = await res.json();

       // üö® NEW: Filter expired events in search/filter too
    const now = new Date().toISOString();
    const liveEvents = events.filter(event => {
      const endTime = event.end_time || new Date(new Date(event.start_time).getTime() + 24*60*60*1000).toISOString();
      return endTime > now;
    });

      renderEvents(eventsEl, liveEvents);
    } catch (error) {
      loadEvents();
    }
  }

  function renderEvents(container, events) {
    if (!events?.length) {
      container.innerHTML = `
        <div class="empty-state">
          <h3>No events match your search</h3>
          <p>Try different keywords or categories</p>
          <a href="#" onclick="loadEvents()" class="btn outline">Show All Events</a>
        </div>
      `;
      return;
    }

    container.innerHTML = events.map(event => `
      <a href="/event.html?e=${event.uuid}" class="event-card glass" style="text-decoration: none;">
        <div class="event-image" style="background: linear-gradient(45deg, ${event.category === 'technical' ? '#667eea' : '#f093fb'}, ${event.category === 'sports' ? '#f6d365' : '#667eea'}); height: 120px; border-radius: 12px 12px 0 0;"></div>
        <div class="event-body">
          <h4>${event.title}</h4>
          <div class="event-meta">
            <span class="badge">${event.category?.toUpperCase() || 'EVENT'}</span>
            <span class="date">${new Date(event.start_time).toLocaleDateString()}</span>
            ${event.price_cents ? `<span class="price">‚Çπ${(event.price_cents/100).toFixed(0)}</span>` : '<span class="free">FREE</span>'}
          </div>
          <p class="event-desc truncate">${event.description || 'Exciting campus event!'}</p>
          <div class="event-status">
            ${event.status === 'published' ? '<span class="status-badge success">Live</span>' : '<span class="status-badge">Draft</span>'}
            ${event.capacity ? `<span>Capacity: ${event.capacity - (event.registrations || 0)} left</span>` : ''}
          </div>
        </div>
      </a>
    `).join('');
  }
</script>
</body>
</html>