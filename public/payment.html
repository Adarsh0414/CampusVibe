<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ef4444">
  <title>Payment - CampusVibe</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script src="/assets/js/lottie.min.js"></script>
  <style>
    .payment-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .payment-card { padding: 20px; border-radius: 12px; background: rgba(255,255,255,0.05); }
    @media (max-width: 768px) { .payment-row { grid-template-columns: 1fr; } }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; height: 100px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .loading-state { text-align: center; padding: 40px; color: #666; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <header class="cv-header">
    <div class="container header-inner">
      <a href="/" class="brand" style="text-decoration:none;color:inherit">
        <img src="/assets/img/logo.svg" class="logo" alt="CampusVibe" />
        <div class="brand-text">
          <h1>CampusVibe</h1>
          <p class="tagline">Ideal Management, Ideal Moments</p>
        </div>
      </a>
      <a class="btn outline" href="/">Home</a>
    </div>
  </header>

  <main class="container" style="padding:24px 0;">
    <div class="card">
        <h2>Complete Payment</h2>
        <p class="muted">Transfer the fee to the organizer using the details below. Then submit your transaction ID and screenshot for verification.</p>
        <div id="details"></div>
        <div id="summary" class="card" style="margin-top:12px; background: rgba(255,255,255,0.03);"></div>
        <div id="lottie-pay" style="height:140px; opacity:.5; margin-top:8px;"></div>
    </div>
    <div class="card" style="margin-top:24px;">
      <h3>Submit Payment Proof</h3>
      <p class="muted">Enter your transaction ID and upload screenshot for verification.</p>
      <form id="proofForm" novalidate>
        <div class="flex-col" style="margin-bottom: 16px;">
          <label class="label">Transaction ID</label>
          <input class="input" id="txn" placeholder="TXN123456789" required />
        </div>
        <div class="flex-col" style="margin-bottom: 16px;">
          <label class="label">Screenshot (JPEG/PNG)</label>
          <input class="input" id="file" type="file" accept="image/jpeg,image/png" required />
          <small class="muted">Upload proof of payment</small>
        </div>
        <button class="btn primary" type="submit" id="submitProof">
          <span class="spinner" style="display:none;"></span>
          Submit Proof
        </button>
      </form>
      <div id="msg"></div>
    </div>
  </main>
  
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(location.search);
  const eUuid = params.get('e');
  const tUuid = params.get('t');
  
  if (!eUuid || !tUuid) {
    document.querySelector('.card').innerHTML = '<div class="alert warn">Invalid payment link</div>';
    return;
  }

  // Show skeletons
  showLoading();
  await loadDetails();
  initLottie();
});

async function showLoading() {
  document.getElementById('details').innerHTML = '<div class="loading-state"><div class="skeleton"></div><p>Loading payment details...</p></div>';
}

async function loadDetails() {
  const params = new URLSearchParams(location.search);
  const eUuid = params.get('e');
  const tUuid = params.get('t');
  
  try {
    // Load event payment details
    const res = await fetch(`/api/events/${eUuid}/payment-setup`);
    if (!res.ok) throw new Error('Payment setup not found');
    const { payment } = await res.json();
    
    // Load ticket summary
    const tRes = await fetch(`/api/tickets/${tUuid}`, { credentials: 'include' });
    let ticket = {};
    if (tRes.ok) {
      ({ ticket } = await tRes.json());
    } else {
      location.href = '/login.html';
      return;
    }
    
    renderPaymentDetails(payment, ticket);
  } catch (error) {
    document.getElementById('details').innerHTML = '<div class="alert warn">Failed to load payment details. <a href="/">Try again</a></div>';
  }
}

function renderPaymentDetails(payment, ticket) {
  const participants = ticket.participants_json ? JSON.parse(ticket.participants_json) : [];
  const groupType = ticket.group_type || 'single';
  const amountDue = (ticket.amount_due_cents || 0) / 100;
  
  document.getElementById('details').innerHTML = `
    <div class="payment-row">
      <div class="payment-card">
        <h4>üè¶ Bank Transfer</h4>
        <p><strong>Account:</strong> ${payment.bank_account_name || 'N/A'}</p>
        <p><strong>Account No:</strong> ${payment.bank_account_no || 'N/A'}</p>
        <p><strong>IFSC:</strong> ${payment.bank_ifsc || 'N/A'}</p>
        ${payment.payment_notes ? `<p class="muted"><strong>Notes:</strong> ${payment.payment_notes}</p>` : ''}
      </div>
      <div class="payment-card">
        <h4>üí≥ UPI / GPay</h4>
        <p><strong>UPI ID:</strong> ${payment.upi_id || 'N/A'}</p>
        ${payment.upi_qr_url ? `<img src="${payment.upi_qr_url}" alt="UPI QR Code" style="max-width:100%;border-radius:12px;margin-top:12px;" />` : '<p class="muted">No QR code available</p>'}
      </div>
    </div>
    
    <div id="summary" class="payment-card" style="margin-top:20px;">
      <h4>üìã Ticket Summary</h4>
      <p><strong>Event:</strong> ${ticket.event_title}</p>
      <p><strong>Type:</strong> ${groupType.charAt(0).toUpperCase() + groupType.slice(1)}</p>
      ${participants.length ? `
        <div style="margin:12px 0;">
          <strong>Participants (${participants.length}):</strong>
          <ul style="margin:8px 0 0 20px; font-size:14px;">
            ${participants.map((p,i) => `<li>${p.name || 'N/A'} (${p.roll_number || '-'})</li>`).join('')}
          </ul>
        </div>
      ` : ''}
      <p style="font-size:18px;font-weight:bold;color:#10b981;margin-top:12px;">
        üí∞ Amount Due: <span style="font-size:22px;">‚Çπ${amountDue}</span>
      </p>
    </div>
  `;
  
  initForm();
}

function initForm() {
  const form = document.getElementById('proofForm');
  const submitBtn = document.getElementById('submitProof');
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const txn = document.getElementById('txn').value.trim();
    const file = document.getElementById('file').files[0];
    
    if (!txn || !file) {
      showMessage('Please enter transaction ID and upload screenshot', 'error');
      return;
    }
    
    setLoading(true);
    try {
      const fd = new FormData();
      const params = new URLSearchParams(location.search);
      fd.append('ticket_uuid', params.get('t'));
      fd.append('txn_id', txn);
      fd.append('screenshot', file);
      
      const res = await fetch('/api/payments/proof', {
        method: 'POST',
        credentials: 'include',
        body: fd
      });
      
      if (res.ok) {
        showMessage('‚úÖ Payment proof submitted successfully! Waiting for verification.', 'success');
        setTimeout(() => location.href = '/my-tickets.html', 2000);
      } else {
        showMessage('‚ùå Submission failed. Please try again.', 'error');
      }
    } catch (error) {
      showMessage('Network error. Please check your connection.', 'error');
    } finally {
      setLoading(false);
    }
  });
}

function setLoading(loading) {
  const btn = document.getElementById('submitProof');
  const spinner = btn.querySelector('.spinner');
  btn.disabled = loading;
  
  if (loading) {
    spinner.style.display = 'inline-block';
    btn.innerHTML = '<span class="spinner"></span>Submitting...';
  } else {
    spinner.style.display = 'none';
    btn.textContent = 'Submit Proof';
  }
}

function showMessage(text, type) {
  const msg = document.getElementById('msg');
  msg.innerHTML = `<div class="alert ${type}">${text}</div>`;
  setTimeout(() => msg.innerHTML = '', 5000);
}

function initLottie() {
  try {
    if (window.lottie) {
      window.lottie.loadAnimation({
        container: document.getElementById('lottie-pay'),
        renderer: 'svg', loop: true, autoplay: true,
        path: '/assets/lottie/pay.json'
      });
    }
  } catch (e) { console.warn('Lottie failed'); }
}
</script>
</body>
</html>
